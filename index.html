<meta charset=utf-8>
<script src='svg.js'></script>
<script>
onload=function(){
  svg=new SVG(300,300);
  svg.trans={x:10,y:10,w:1,h:1};
  svg.lineWidth=0.1;
  var wmin=40;
  var wmax=50;
  var height=80;
  var numsections=9;
  var thickness=3;
  var duktaJoint=0.2;
  var supportLength=1.5*thickness;
  var supportDepth=1*thickness;
  var cutDepth=1*thickness;
  var edgeSupportDepth=1*thickness;

  var sections=[];
  var N=5;
  var wshift=10;
  for(var i=0;i<numsections;i++){
    sections.push(
      [i-0.5,i+0.5].map(function(y){
        return {x: Math.cos(y/(numsections-1)*Math.PI),y:y,i:i}
      })
    );
  }
  var sfirst=sections[0][0],slast=sections[numsections-1][0];
  sections = sections.map(function(s){
    return s.map(function(p){
      return {
        x: ((p.x-sfirst.x)/(slast.x-sfirst.x)-0.5)*(wmax-wmin)/2,
        y: (p.y-sfirst.y)/(slast.y-sfirst.y)*height,
        i: p.i
      }
    });
  })
  sections.forEach(function(s){
    var lines=[];
    for(var i=0;i<=N;i++){
      var cy=(s[0].y+s[1].y)/2
      var line = s.map(function(p){
        return {
          x: (i%2?1:-1)*p.x+(wmin+wmax)/2*i+cy*wshift/height,
          y: p.y
        }
      });
      svg.line(line);
      lines.push(line)
    }
    var first=(s==sections[0]),last=(s==sections[sections.length-1]);
    if(first)svg.line([lines[0][0],lines[lines.length-1][0]]);
    if(last)svg.line([lines[0][1],lines[lines.length-1][1]])
    for(var i=0;i<=N;i++){
      var xsec=lines[i][1].x+wshift/numsections/2;
      var w0=lines[i-1]?(lines[i][1].x-lines[i-1][1].x)*(1-duktaJoint)/2:+wshift/numsections/2;
      var w1=lines[i+1]?(lines[i+1][1].x-lines[i][1].x)*(1-duktaJoint)/2:wshift/numsections/2;
      //section dukta
      if(!last)svg.line([
        {x:xsec-w0,y:lines[i][1].y},
        {x:xsec+w1,y:lines[i][1].y}
      ])
      //center dukta
      if(!first&&!last&&i!=N){
        var cx=(lines[i][1].x+lines[i+1][1].x)/2;
        var cy=(lines[i][0].y+lines[i][1].y)/2;
        var w=(lines[i+1][0].x+lines[i+1][1].x-lines[i][0].x-lines[i][1].x)/2-(supportDepth+supportLength)*2;
        svg.line([
          {x:cx-w*(1-duktaJoint)/2,y:cy},
          {x:cx+w*(1-duktaJoint)/2,y:cy}
        ])
      }

      if(first||last){
        var x=lines[i][0].x;
        var y=(lines[i][0].y+lines[i][1].y)/2;
        var d1=0,d2=0;
        if(i==0||i==N){
          d2=i?-cutDepth:cutDepth;
        }else{
          d1=d2=cutDepth;
        }
        //cut
        svg.line([
          {x:x-d1,y:y-thickness/2},{x:x+d2,y:y-thickness/2},
          {x:x+d2,y:y+thickness/2},{x:x-d1,y:y+thickness/2}
        ],d1&&d2)
        //edgesupport
        var rx=cutDepth+edgeSupportDepth,rw=supportLength;
        var params=[-1,1];
        if(i==0)params=[1];
        if(i==N)params=[-1];
        params.forEach(function(t){
          svg.line([
            {x:x+t*rx,y:y-thickness/2},{x:x+t*(rx+rw),y:y-thickness/2},
            {x:x+t*(rx+rw),y:y+thickness/2},{x:x+t*rx,y:y+thickness/2},
          ],true)
        })
      }
      //support
      if(!first&&!last&&s[0].i%2==0){
        var x=(lines[i][0].x+lines[i][1].x)/2;
        var y=(lines[i][0].y+lines[i][1].y)/2;
        var lx=(lines[i][1].y-lines[i][0].y)/2;
        var ly=(lines[i][0].x-lines[i][1].x)/2;
        var lr=Math.sqrt(lx*lx+ly*ly);
        lx/=lr;ly/=lr;
        var rx=supportDepth,rw=supportLength,ry=thickness/2;
        var params=[-1,1];
        if(i==0)params=[1];
        if(i==N)params=[-1];
        params.forEach(function(t){
          svg.line([
            {x:x+t*rx*lx-ry*ly,y:y+t*rx*ly+lx*ry},
            {x:x+t*(rx+rw)*lx-ry*ly,y:y+t*(rx+rw)*ly+lx*ry},
            {x:x+t*(rx+rw)*lx+ry*ly,y:y+t*(rx+rw)*ly-lx*ry},
            {x:x+t*rx*lx+ry*ly,y:y+t*rx*ly-lx*ry},
          ],true)
        })
      }
    }
  })

  
  svg.trans.x=47;
  svg.trans.y=135;
  var bottomR=wmin/Math.tan(Math.PI/N)/2;
  var points=[];
  for(var i=0;i<N;i++){
    var t=2*Math.PI*i/N,cos=Math.cos(t),sin=Math.sin(t);
    function trans(x,y){return {x:x*cos-y*sin,y:x*sin+y*cos};}
    points.push(trans(bottomR,-wmin/2+cutDepth+edgeSupportDepth));
    points.push(trans(bottomR+thickness,-wmin/2+cutDepth+edgeSupportDepth));
    points.push(trans(bottomR+thickness,-wmin/2+cutDepth+edgeSupportDepth+supportLength));
    points.push(trans(bottomR,-wmin/2+cutDepth+edgeSupportDepth+supportLength));
    points.push(trans(bottomR,wmin/2-cutDepth-edgeSupportDepth-supportLength));
    points.push(trans(bottomR+thickness,wmin/2-cutDepth-edgeSupportDepth-supportLength));
    points.push(trans(bottomR+thickness,wmin/2-cutDepth-edgeSupportDepth));
    points.push(trans(bottomR,wmin/2-cutDepth-edgeSupportDepth));
  }
  svg.line(points,true);

  svg.trans.x=82-points[4].x;
  svg.trans.y=101-points[4].y;
  for(var i=0;i<N;i++){
    svg.line(points.slice(4,12),true)
    svg.trans.x+=7;
  }
  svg.trans.x=111;svg.trans.y=112
  for(var i=0;i<2*N;i++){
    var points=[];
    var dir={x:-Math.sin(2*Math.PI/N),y:Math.cos(2*Math.PI/N)};
    var ps=[
      {x:thickness,y:cutDepth+edgeSupportDepth+supportLength},
      {x:thickness,y:cutDepth},
      {x:0,y:cutDepth},
      {x:0,y:cutDepth+edgeSupportDepth}
    ];
    [0,1,2,3].forEach(function(i){
      points.push({x:ps[i].x,y:-ps[i].y})  
    });
    [3,2,1,0].forEach(function(i){
      points.push({x:ps[i].x*dir.y+ps[i].y*dir.x,y:-ps[i].x*dir.x+ps[i].y*dir.y})  
    })
    svg.line(points);
    k=1.25;
    svg.curve([
      points[0],
      {x:k*cutDepth*Math.cos(Math.PI/N),y:k*cutDepth*Math.sin(Math.PI/N)},
      points[7]
    ]);
    svg.trans.x+=10;
  }
  sections.forEach(function(s){
    // s[]
  })



  var img=new Image();
  img.src=svg.toDataURL();
  img.style.border='1px solid red'
  document.body.appendChild(img);
}

</script>